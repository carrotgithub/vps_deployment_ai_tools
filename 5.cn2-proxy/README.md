# CN2 VPS åå‘ä»£ç†éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€ç»ˆç”¨æˆ·                                                      â”‚
â”‚ https://newapi.tunecoder.example.com (CN2 çº¿è·¯)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CN2 è½»é‡VPS (å‰ç«¯è½¬å‘å±‚)                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ â”‚   Nginx (HTTPS åå‘ä»£ç†)             â”‚                     â”‚
â”‚ â”‚   åŸŸå: newapi.tunecoder.example.com        â”‚                     â”‚
â”‚ â”‚   åŠŸèƒ½: è½¬å‘åˆ°æ€§èƒ½æœåŠ¡å™¨             â”‚                     â”‚
â”‚ â”‚   è¶…æ—¶: 600ç§’ | SSE: æ”¯æŒ            â”‚                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ â”‚   V2Ray æœåŠ¡ç«¯ (å¯é€‰ï¼Œç¿»å¢™ç”¨)        â”‚                     â”‚
â”‚ â”‚   ä¸ API è½¬å‘æ— å…³                    â”‚                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ å…¬ç½‘ HTTPS
                     â”‚ proxy_pass https://api.tunecoder.example.com
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€§èƒ½æœåŠ¡å™¨ (åç«¯ä¸šåŠ¡å±‚)                                       â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚            Nginx (HTTPS ç›‘å¬ 443)                    â”‚     â”‚
â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â”‚             â”‚             â”‚                           â”‚
â”‚     â–¼             â–¼             â–¼                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚ â”‚New-API  â”‚  â”‚LiteLLM  â”‚  â”‚CliproxyAPI   â”‚                â”‚
â”‚ â”‚(3000)   â”‚  â”‚(4000)   â”‚  â”‚(8317)        â”‚                â”‚
â”‚ â”‚         â”‚  â”‚         â”‚  â”‚              â”‚                â”‚
â”‚ â”‚api.     â”‚  â”‚litellm. â”‚  â”‚cliproxyapi.  â”‚                â”‚
â”‚ â”‚tunecoderâ”‚  â”‚tunecoderâ”‚  â”‚tunecoder.example.com â”‚                â”‚
â”‚ â”‚.com     â”‚  â”‚.com     â”‚  â”‚              â”‚                â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚      â”‚            â”‚               â”‚                         â”‚
â”‚      â”‚  å†…éƒ¨è°ƒç”¨: LiteLLM â†’ CliproxyAPI                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ New-API â†’ CliproxyAPI + LiteLLM           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ éƒ¨ç½²ç›®æ ‡

**ç”¨æˆ·è®¿é—®æµç¨‹ï¼š**
```
ç”¨æˆ· â†’ CN2 VPS (newapi.tunecoder.example.com)
     â†’ æ€§èƒ½æœåŠ¡å™¨ Nginx (api.tunecoder.example.com)
     â†’ New-API (localhost:3000)
     â†’ CliproxyAPI æˆ– LiteLLM
     â†’ ä¸Šæ¸¸ AI æœåŠ¡å•†
```

**ç®¡ç†å‘˜è®¿é—®æµç¨‹ï¼ˆé€šè¿‡ V2Ray ç¿»å¢™ï¼‰ï¼š**
```
ç®¡ç†å‘˜ â†’ V2Ray å®¢æˆ·ç«¯
      â†’ CN2 VPS V2Ray æœåŠ¡ç«¯
      â†’ ç›´æ¥è®¿é—®æ€§èƒ½æœåŠ¡å™¨ç®¡ç†å°:
         â€¢ https://api.tunecoder.example.com (New-API)
         â€¢ https://litellm.tunecoder.example.com/ui (LiteLLM)
         â€¢ https://cliproxyapi.tunecoder.example.com/v0/ (CliproxyAPI)
```

---

## ğŸ“¦ éƒ¨ç½²å‰ææ¡ä»¶

### æ€§èƒ½æœåŠ¡å™¨ï¼ˆå·²å®Œæˆï¼‰

âœ… å·²éƒ¨ç½²ä»¥ä¸‹æœåŠ¡ï¼š
- Nginx 1.28.1 + HTTP/3
- New-API (Docker) - `api.tunecoder.example.com`
- LiteLLM (Docker) - `litellm.tunecoder.example.com`
- CliproxyAPI (äºŒè¿›åˆ¶) - `cliproxyapi.tunecoder.example.com`

âœ… æ‰€æœ‰æœåŠ¡å·²ç”³è¯· Let's Encrypt è¯ä¹¦

### CN2 VPSï¼ˆå¾…éƒ¨ç½²ï¼‰

éœ€è¦å‡†å¤‡ï¼š
1. âœ… å·²éƒ¨ç½² Nginx 1.28.1 + HTTP/3
2. âœ… DNS é…ç½®ï¼š`newapi.tunecoder.example.com` â†’ CN2 VPS IP
3. â³ V2Ray ç¿»å¢™èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼Œä¸ API æ— å…³ï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ€§èƒ½æœåŠ¡å™¨éƒ¨ç½²ï¼ˆå·²å®Œæˆï¼‰

å¦‚æœå°šæœªéƒ¨ç½²ï¼Œè¯·ä¾æ¬¡è¿è¡Œï¼š

```bash
# 1. éƒ¨ç½² Nginx
cd "0.nginxéƒ¨ç½²ï¼ˆ1.28.1 HTTP3ï¼‰"
./install_nginx.sh

# 2. éƒ¨ç½² New-API
cd "../3.new-api"
./install_newapi_docker.sh
# è¾“å…¥åŸŸå: api.tunecoder.example.com

# 3. éƒ¨ç½² LiteLLM
cd "../4.litellm"
./install_litellm_docker.sh
# è¾“å…¥åŸŸå: litellm.tunecoder.example.com

# 4. éƒ¨ç½² CliproxyAPI
cd "../2.cliproxyapi"
./install_cliproxyapi_v2.sh
# è¾“å…¥åŸŸå: cliproxyapi.tunecoder.example.com
```

**éªŒè¯éƒ¨ç½²ï¼š**
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status nginx
cd /opt/docker-services/new-api && docker compose ps
cd /opt/docker-services/litellm && docker compose ps
systemctl status cliproxyapi

# æ£€æŸ¥ SSL è¯ä¹¦
ls -lh /usr/local/nginx/conf/ssl/api.tunecoder.example.com/
ls -lh /usr/local/nginx/conf/ssl/litellm.tunecoder.example.com/
ls -lh /usr/local/nginx/conf/ssl/cliproxyapi.tunecoder.example.com/
```

---

### ç¬¬äºŒæ­¥ï¼šCN2 VPS éƒ¨ç½² Nginx

```bash
# 1. éƒ¨ç½² Nginxï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
cd "0.nginxéƒ¨ç½²ï¼ˆ1.28.1 HTTP3ï¼‰"
./install_nginx.sh
```

---

### ç¬¬ä¸‰æ­¥ï¼šCN2 VPS é…ç½® SSL è¯ä¹¦

è„šæœ¬æ”¯æŒä¸‰ç§æ¨¡å¼ï¼š
- **åŸŸåæ¨¡å¼**ï¼šè‡ªåŠ¨ç”³è¯· Let's Encrypt è¯ä¹¦ï¼ˆæ¨èï¼‰
- **IP æ¨¡å¼**ï¼šä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œæ— éœ€åŸŸå
- **HTTP æ¨¡å¼**ï¼šæ—  SSL è¯ä¹¦ï¼Œä»…é™å†…ç½‘/å¼€å‘ç¯å¢ƒ

```bash
cd "5.cn2-vpsåå‘ä»£ç†"

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x apply_ssl_cn2.sh

# åŸŸåæ¨¡å¼ï¼ˆæ¨èï¼‰
./apply_ssl_cn2.sh -d newapi.tunecoder.example.com

# IP æ¨¡å¼ï¼ˆæ— éœ€åŸŸåï¼‰
./apply_ssl_cn2.sh -i 1.2.3.4

# HTTP æ¨¡å¼ï¼ˆæ—  SSLï¼‰
./apply_ssl_cn2.sh -h 1.2.3.4
```

**è„šæœ¬ä¼šè‡ªåŠ¨ï¼š**
1. åŸŸåæ¨¡å¼ï¼šæ£€æŸ¥å¹¶ä¿®å¤ acme.sh é‚®ç®±é…ç½®
2. åŸŸåæ¨¡å¼ï¼šåˆ›å»ºä¸´æ—¶ Nginx é…ç½®ç”¨äº ACME éªŒè¯
3. åŸŸåæ¨¡å¼ï¼šç”³è¯· Let's Encrypt ECC-256 è¯ä¹¦
4. IP æ¨¡å¼ï¼šç›´æ¥ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼ˆ10å¹´æœ‰æ•ˆæœŸï¼‰
5. HTTP æ¨¡å¼ï¼šè·³è¿‡ SSL è¯ä¹¦é…ç½®
6. å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°è‡ªç­¾åè¯ä¹¦

**æˆåŠŸåä¼šçœ‹åˆ°ï¼š**
```
âœ“ SSL è¯ä¹¦é…ç½®å®Œæˆï¼
è®¿é—®æ¨¡å¼: åŸŸåæ¨¡å¼/IP æ¨¡å¼/HTTP æ¨¡å¼
è¯ä¹¦ç±»å‹: Let's Encrypt (ECC-256) æˆ– è‡ªç­¾åè¯ä¹¦ (IP æ¨¡å¼) æˆ– æ—  (HTTP æ¨¡å¼)
è¯ä¹¦è·¯å¾„: /usr/local/nginx/conf/ssl/newapi.tunecoder.example.com/
```

**IP æ¨¡å¼æ³¨æ„äº‹é¡¹ï¼š**
- æµè§ˆå™¨ä¼šæç¤ºã€Œä¸å®‰å…¨ã€ï¼Œè¯·ç‚¹å‡»ã€Œé«˜çº§ã€â†’ã€Œç»§ç»­è®¿é—®ã€
- API å®¢æˆ·ç«¯å¯èƒ½éœ€è¦å…³é—­ SSL éªŒè¯

**HTTP æ¨¡å¼æ³¨æ„äº‹é¡¹ï¼š**
- æ•°æ®ä¼ è¾“ä¸åŠ å¯†ï¼ŒAPI Key å¯èƒ½æ³„éœ²
- ä»…å»ºè®®åœ¨å†…ç½‘æˆ–å¼€å‘ç¯å¢ƒä½¿ç”¨

---

### ç¬¬å››æ­¥ï¼šé…ç½® Nginx åå‘ä»£ç†

#### 4.1 æ·»åŠ  WebSocket å‡çº§é…ç½®ï¼ˆä»…éœ€æ‰§è¡Œä¸€æ¬¡ï¼‰

ç¼–è¾‘ Nginx ä¸»é…ç½®æ–‡ä»¶ï¼š
```bash
nano /usr/local/nginx/conf/nginx.conf
```

åœ¨ `http { }` å—ä¸­æ·»åŠ ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š
```nginx
http {
    # ... ç°æœ‰é…ç½® ...

    # WebSocket Connection Upgrade Map
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # è¿æ¥æ± ä¼˜åŒ–
    upstream_keepalive_timeout 300s;

    # ... ç°æœ‰é…ç½® ...
}
```

ä¿å­˜å¹¶æµ‹è¯•é…ç½®ï¼š
```bash
/usr/local/nginx/sbin/nginx -t
```

#### 4.2 éƒ¨ç½²åå‘ä»£ç†é…ç½®

```bash
cd "5.cn2-vpsåå‘ä»£ç†"

# å¤åˆ¶é…ç½®æ–‡ä»¶
cp nginx_newapi_proxy.conf /usr/local/nginx/conf/conf.d/newapi.tunecoder.example.com.conf

# æµ‹è¯•é…ç½®
/usr/local/nginx/sbin/nginx -t

# é‡è½½ Nginx
systemctl reload nginx
```

---

### ç¬¬äº”æ­¥ï¼šéªŒè¯éƒ¨ç½²

```bash
cd "5.cn2-vpsåå‘ä»£ç†"

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x test_proxy.sh

# è¿è¡Œæµ‹è¯•è„šæœ¬
./test_proxy.sh
```

**æµ‹è¯•è„šæœ¬ä¼šæ£€æŸ¥ï¼š**
1. âœ… DNS è§£ææ˜¯å¦æ­£ç¡®
2. âœ… æ€§èƒ½æœåŠ¡å™¨è¿é€šæ€§
3. âœ… SSL è¯ä¹¦æœ‰æ•ˆæ€§
4. âœ… Nginx é…ç½®è¯­æ³•
5. âœ… åå‘ä»£ç†å“åº”
6. âœ… SSE æµå¼ä¼ è¾“é…ç½®
7. âœ… è¶…æ—¶é…ç½®ï¼ˆ600ç§’ï¼‰
8. âœ… æ—¥å¿—æ–‡ä»¶è®¿é—®

**æ‰€æœ‰æµ‹è¯•é€šè¿‡åä¼šæ˜¾ç¤ºï¼š**
```
âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
â€¢ CN2 VPS åå‘ä»£ç†æ­£å¸¸è¿è¡Œ
â€¢ SSL è¯ä¹¦é…ç½®æ­£ç¡®
â€¢ SSE æµå¼ä¼ è¾“å·²å¯ç”¨
â€¢ è¶…æ—¶é…ç½®ç¬¦åˆè¦æ±‚ (600ç§’)
```

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### æµ‹è¯• 1: åŸºæœ¬è¿é€šæ€§

```bash
# æµ‹è¯• CN2 VPS è®¿é—®
curl -I https://newapi.tunecoder.example.com

# åº”è¿”å› 200 æˆ– 401ï¼ˆéœ€è¦è®¤è¯ï¼‰
```

### æµ‹è¯• 2: API è°ƒç”¨ï¼ˆéœ€è¦ API Keyï¼‰

```bash
# åœ¨æ€§èƒ½æœåŠ¡å™¨çš„ New-API ç®¡ç†å°åˆ›å»º API Key
# è®¿é—®: https://api.tunecoder.example.com
# é»˜è®¤ç”¨æˆ·: root / 123456

# ä½¿ç”¨ CN2 åŸŸåæµ‹è¯•
curl https://newapi.tunecoder.example.com/v1/models \
  -H "Authorization: Bearer YOUR_API_KEY"
```

### æµ‹è¯• 3: SSE æµå¼ä¼ è¾“

```bash
curl https://newapi.tunecoder.example.com/v1/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-4",
    "messages": [{"role": "user", "content": "Hello"}],
    "stream": true
  }'

# åº”çœ‹åˆ°é€è¡Œè¿”å›çš„ data: æµ
```

### æµ‹è¯• 4: å“åº”æ—¶é—´

```bash
curl -o /dev/null -s -w "Time: %{time_total}s\n" \
  https://newapi.tunecoder.example.com/v1/models \
  -H "Authorization: Bearer YOUR_API_KEY"
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹ CN2 VPS æ—¥å¿—

```bash
# è®¿é—®æ—¥å¿—ï¼ˆåŒ…å«å“åº”æ—¶é—´ï¼‰
tail -f /var/log/nginx/newapi_proxy_access.log

# é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/newapi_proxy_error.log

# å®æ—¶ç›‘æ§ï¼ˆæ¯5ç§’åˆ·æ–°ï¼‰
watch -n 5 'tail -10 /var/log/nginx/newapi_proxy_access.log'
```

### æ—¥å¿—æ ¼å¼è¯´æ˜

è®¿é—®æ—¥å¿—åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š
- `rt`: æ€»è¯·æ±‚æ—¶é—´
- `uct`: ä¸Šæ¸¸è¿æ¥æ—¶é—´
- `uht`: ä¸Šæ¸¸å“åº”å¤´æ—¶é—´
- `urt`: ä¸Šæ¸¸å“åº”æ€»æ—¶é—´

**ç¤ºä¾‹æ—¥å¿—ï¼š**
```
1.2.3.4 - - [05/Jan/2026:12:00:00 +0000] "POST /v1/chat/completions HTTP/2.0" 200 1234
"https://example.com" "curl/7.68.0" rt=2.345 uct="0.010" uht="0.050" urt="2.340"
```

è¡¨ç¤ºï¼š
- æ€»è¯·æ±‚æ—¶é—´: 2.345ç§’
- è¿æ¥åç«¯ç”¨æ—¶: 0.010ç§’
- åç«¯å“åº”å¤´ç”¨æ—¶: 0.050ç§’
- åç«¯å®Œæ•´å“åº”ç”¨æ—¶: 2.340ç§’

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: SSL è¯ä¹¦ç”³è¯·å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
Let's Encrypt è¯ä¹¦ç”³è¯·å¤±è´¥
é™çº§ä¸ºè‡ªç­¾åè¯ä¹¦
```

**æ’æŸ¥æ­¥éª¤ï¼š**
```bash
# 1. æ£€æŸ¥ DNS è§£æ
dig +short newapi.tunecoder.example.com
# åº”è¿”å› CN2 VPS çš„ IP

# 2. æ£€æŸ¥ 80 ç«¯å£æ˜¯å¦å¼€æ”¾
netstat -tlnp | grep :80

# 3. æµ‹è¯• ACME éªŒè¯è·¯å¾„
curl http://newapi.tunecoder.example.com/.well-known/acme-challenge/test

# 4. æŸ¥çœ‹ acme.sh æ—¥å¿—
cat ~/.acme.sh/acme.sh.log

# 5. æ‰‹åŠ¨é‡è¯•
./apply_ssl_cn2.sh -d newapi.tunecoder.example.com
```

---

### é—®é¢˜ 2: 502 Bad Gateway

**ç—‡çŠ¶ï¼š**
```
è®¿é—® https://newapi.tunecoder.example.com è¿”å› 502
```

**æ’æŸ¥æ­¥éª¤ï¼š**
```bash
# 1. æ£€æŸ¥æ€§èƒ½æœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®
curl -I https://api.tunecoder.example.com
# åº”è¿”å› 200

# 2. æ£€æŸ¥é˜²ç«å¢™
iptables -L -n | grep 443

# 3. æµ‹è¯•åç«¯è¿æ¥
curl -v https://api.tunecoder.example.com 2>&1 | grep "Connected"

# 4. æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
tail -50 /var/log/nginx/newapi_proxy_error.log

# 5. æµ‹è¯• DNS è§£æ
nslookup api.tunecoder.example.com
```

---

### é—®é¢˜ 3: è¯·æ±‚è¶…æ—¶

**ç—‡çŠ¶ï¼š**
```
AI é•¿å“åº”æ—¶è¢«ä¸­æ–­
curl: (28) Operation timed out
```

**æ’æŸ¥æ­¥éª¤ï¼š**
```bash
# 1. æ£€æŸ¥è¶…æ—¶é…ç½®
grep "timeout" /usr/local/nginx/conf/conf.d/newapi.tunecoder.example.com.conf

# åº”çœ‹åˆ°:
# proxy_read_timeout 600s;
# proxy_send_timeout 600s;

# 2. å¦‚æœè¶…æ—¶é…ç½®ä¸æ­£ç¡®ï¼Œä¿®æ”¹é…ç½®
nano /usr/local/nginx/conf/conf.d/newapi.tunecoder.example.com.conf

# æ‰¾åˆ°å¹¶ä¿®æ”¹ä¸º:
proxy_read_timeout 600s;
proxy_send_timeout 600s;

# 3. é‡è½½ Nginx
nginx -t && systemctl reload nginx
```

---

### é—®é¢˜ 4: SSE æµå¼ä¼ è¾“ä¸å·¥ä½œ

**ç—‡çŠ¶ï¼š**
```
æµå¼å“åº”è¢«ç¼“å†²ï¼Œæ— æ³•å®æ—¶æ˜¾ç¤º
```

**æ’æŸ¥æ­¥éª¤ï¼š**
```bash
# 1. æ£€æŸ¥ç¼“å†²é…ç½®
grep "buffering" /usr/local/nginx/conf/conf.d/newapi.tunecoder.example.com.conf

# åº”çœ‹åˆ°:
# proxy_buffering off;
# proxy_cache off;
# proxy_request_buffering off;

# 2. æ£€æŸ¥æ˜¯å¦æœ‰ gzip å‹ç¼©å¹²æ‰°
grep "gzip" /usr/local/nginx/conf/nginx.conf

# 3. æ·»åŠ è°ƒè¯•å¤´
curl -I https://newapi.tunecoder.example.com/v1/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY" \
  | grep "X-Accel-Buffering"

# åº”è¿”å›: X-Accel-Buffering: no
```

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. é™åˆ¶è®¿é—®æ¥æºï¼ˆå¯é€‰ï¼‰

å¦‚æœåªå…è®¸ç‰¹å®š IP è®¿é—®ï¼Œåœ¨ Nginx é…ç½®ä¸­æ·»åŠ ï¼š

```nginx
location / {
    # å…è®¸ç‰¹å®š IP
    allow 1.2.3.4;
    # æ‹’ç»å…¶ä»–
    deny all;

    proxy_pass https://api.tunecoder.example.com;
    # ... å…¶ä»–é…ç½® ...
}
```

### 2. å¯ç”¨è®¿é—®æ—¥å¿—åˆ†æ

```bash
# å®‰è£… GoAccessï¼ˆå®æ—¶æ—¥å¿—åˆ†æå·¥å…·ï¼‰
apt-get install goaccess  # Debian/Ubuntu
yum install goaccess      # CentOS/RHEL

# å®æ—¶åˆ†æè®¿é—®æ—¥å¿—
goaccess /var/log/nginx/newapi_proxy_access.log -o report.html --real-time-html

# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ report.html æŸ¥çœ‹å®æ—¶ç»Ÿè®¡
```

### 3. å®šæœŸå¤‡ä»½é…ç½®

```bash
# å¤‡ä»½ Nginx é…ç½®
tar -czf nginx_config_backup_$(date +%Y%m%d).tar.gz \
  /usr/local/nginx/conf/

# å¤‡ä»½ SSL è¯ä¹¦
tar -czf ssl_certs_backup_$(date +%Y%m%d).tar.gz \
  /usr/local/nginx/conf/ssl/
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### 1. å¯ç”¨ Brotli å‹ç¼©

Brotli æ¯” gzip å‹ç¼©ç‡æ›´é«˜ï¼Œä½†éœ€è¦ç¼–è¯‘ Nginx æ¨¡å—ã€‚

### 2. é…ç½®ç¼“å­˜ï¼ˆä»…é™é™æ€èµ„æºï¼‰

**æ³¨æ„ï¼š** ä¸è¦å¯¹ API ç«¯ç‚¹å¯ç”¨ç¼“å­˜ï¼

```nginx
# ä»…å¯¹ç®¡ç†ç•Œé¢é™æ€èµ„æºç¼“å­˜
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
    proxy_pass https://api.tunecoder.example.com;
    proxy_cache_valid 200 1h;
    add_header X-Cache-Status $upstream_cache_status;
}
```

### 3. å¯ç”¨ TCP BBRï¼ˆéœ€è¦å†…æ ¸æ”¯æŒï¼‰

```bash
# æ£€æŸ¥æ˜¯å¦æ”¯æŒ BBR
sysctl net.ipv4.tcp_congestion_control

# å¦‚æœæ”¯æŒï¼Œå¯ç”¨ BBR
echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
sysctl -p
```

---

## ğŸ“š é™„å½•

### é…ç½®æ–‡ä»¶ä½ç½®

```
CN2 VPS:
â”œâ”€â”€ /usr/local/nginx/conf/nginx.conf (ä¸»é…ç½®)
â”œâ”€â”€ /usr/local/nginx/conf/conf.d/newapi.tunecoder.example.com.conf (åå‘ä»£ç†é…ç½®)
â”œâ”€â”€ /usr/local/nginx/conf/ssl/newapi.tunecoder.example.com/ (SSL è¯ä¹¦)
â””â”€â”€ /var/log/nginx/ (æ—¥å¿—ç›®å½•)
    â”œâ”€â”€ newapi_proxy_access.log
    â””â”€â”€ newapi_proxy_error.log

æ€§èƒ½æœåŠ¡å™¨:
â”œâ”€â”€ /usr/local/nginx/conf/conf.d/api.tunecoder.example.com.conf (New-API)
â”œâ”€â”€ /usr/local/nginx/conf/conf.d/litellm.tunecoder.example.com.conf (LiteLLM)
â”œâ”€â”€ /usr/local/nginx/conf/conf.d/cliproxyapi.tunecoder.example.com.conf (CliproxyAPI)
â””â”€â”€ /usr/local/nginx/conf/ssl/ (SSL è¯ä¹¦)
    â”œâ”€â”€ api.tunecoder.example.com/
    â”œâ”€â”€ litellm.tunecoder.example.com/
    â””â”€â”€ cliproxyapi.tunecoder.example.com/
```

### å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# Nginx ç®¡ç†
systemctl status nginx
systemctl reload nginx
nginx -t
nginx -V

# æ—¥å¿—æŸ¥çœ‹
tail -f /var/log/nginx/newapi_proxy_access.log
tail -f /var/log/nginx/newapi_proxy_error.log

# SSL è¯ä¹¦
~/.acme.sh/acme.sh --list
~/.acme.sh/acme.sh --renew -d newapi.tunecoder.example.com --ecc

# æµ‹è¯•è¿æ¥
curl -I https://newapi.tunecoder.example.com
curl -v https://api.tunecoder.example.com
dig +short newapi.tunecoder.example.com

# æ€§èƒ½æµ‹è¯•
ab -n 100 -c 10 https://newapi.tunecoder.example.com/
```

---

## âœ… éƒ¨ç½²éªŒè¯æ¸…å•

å®Œæˆä»¥ä¸‹æ£€æŸ¥ç¡®è®¤éƒ¨ç½²æˆåŠŸï¼š

- [ ] DNS è§£ææ­£ç¡®ï¼ˆnewapi.tunecoder.example.com â†’ CN2 VPS IPï¼‰
- [ ] SSL è¯ä¹¦ç”³è¯·æˆåŠŸï¼ˆLet's Encrypt æˆ–è‡ªç­¾åï¼‰
- [ ] Nginx é…ç½®è¯­æ³•æ­£ç¡®ï¼ˆ`nginx -t` é€šè¿‡ï¼‰
- [ ] åå‘ä»£ç†å“åº”æ­£å¸¸ï¼ˆ`curl -I https://newapi.tunecoder.example.com` è¿”å› 200/401ï¼‰
- [ ] SSE æµå¼ä¼ è¾“é…ç½®æ­£ç¡®ï¼ˆ`proxy_buffering off`ï¼‰
- [ ] è¶…æ—¶é…ç½®æ­£ç¡®ï¼ˆ`proxy_read_timeout 600s`ï¼‰
- [ ] æ—¥å¿—æ–‡ä»¶æ­£å¸¸å†™å…¥
- [ ] æ€§èƒ½æœåŠ¡å™¨å¯è®¿é—®ï¼ˆ`curl -I https://api.tunecoder.example.com`ï¼‰
- [ ] API è°ƒç”¨æµ‹è¯•é€šè¿‡ï¼ˆä½¿ç”¨ API Key æµ‹è¯•ï¼‰

---

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š`./test_proxy.sh`
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š`tail -50 /var/log/nginx/newapi_proxy_error.log`
3. æ£€æŸ¥ Nginx é…ç½®ï¼š`nginx -t`
4. æµ‹è¯•åç«¯è¿æ¥ï¼š`curl -v https://api.tunecoder.example.com`

---

**éƒ¨ç½²å®Œæˆåï¼Œæ‚¨çš„ç”¨æˆ·å¯ä»¥é€šè¿‡ CN2 çº¿è·¯è®¿é—®ï¼š**
- API Base URL: `https://newapi.tunecoder.example.com`
- äº«å— CN2 çº¿è·¯çš„ä½å»¶è¿Ÿå’Œé«˜ç¨³å®šæ€§
- æ”¯æŒ SSE æµå¼ä¼ è¾“å’Œè¶…é•¿å“åº”ï¼ˆ600ç§’ï¼‰
