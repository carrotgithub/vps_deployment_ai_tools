# ============================================================
# New-API 负载均衡配置（Nginx Stream）
# ============================================================
# 用途：TCP层负载均衡，分发流量到多台CN2 VPS
# 协议：HTTPS/HTTP (TCP透传，不解密)
# ============================================================

# 上游服务器组（CN2节点）
upstream cn2_backend {
    # 负载均衡算法
    # 可选：
    # - least_conn;         最少连接数（推荐用于长连接）
    # - ip_hash;            源IP哈希（会话保持）
    # - hash $remote_addr consistent;  一致性哈希（会话保持）
    # - 默认为轮询(round-robin)

    least_conn;  # 使用最少连接算法

    # CN2节点列表
    # 格式: server <IP>:<端口> [参数];
    #
    # 参数说明：
    # - weight=N         权重（默认1），数值越大分配流量越多
    # - max_fails=N      最大失败次数（默认1），超过后标记为不可用
    # - fail_timeout=Ns  失败超时时间（默认10秒），N秒内失败max_fails次则下线
    # - down             手动下线节点（维护时使用）
    # - backup           备用服务器（仅当主服务器全部不可用时启用）

    server 1.2.3.4:443 weight=1 max_fails=3 fail_timeout=30s;
    server 5.6.7.8:443 weight=1 max_fails=3 fail_timeout=30s;
    server 9.10.11.12:443 weight=1 max_fails=3 fail_timeout=30s;

    # 可选：添加备用节点
    # server 20.30.40.50:443 backup;

    # 注意：Nginx开源版Stream模块不支持主动健康检查
    # 使用外部脚本（nginx_healthcheck.sh）实现健康检查
}

# HTTP上游（用于80端口，通常重定向到HTTPS）
upstream cn2_backend_http {
    least_conn;

    server 1.2.3.4:80 weight=1 max_fails=3 fail_timeout=30s;
    server 5.6.7.8:80 weight=1 max_fails=3 fail_timeout=30s;
    server 9.10.11.12:80 weight=1 max_fails=3 fail_timeout=30s;
}

# ============================================================
# HTTPS负载均衡服务器（Port 443）
# ============================================================
server {
    listen 443;
    listen [::]:443;

    # TCP代理到上游CN2节点
    proxy_pass cn2_backend;

    # ========== 连接超时配置 ==========

    # 连接CN2节点超时时间
    proxy_connect_timeout 10s;

    # TCP连接保持时间（必须足够长以支持AI长响应）
    # 建议：600秒（10分钟）
    proxy_timeout 600s;

    # ========== 缓冲区配置 ==========

    # 上游数据缓冲区大小
    proxy_buffer_size 16k;

    # 下游数据缓冲区大小
    proxy_download_rate 0;  # 0表示不限速
    proxy_upload_rate 0;

    # ========== TCP优化 ==========

    # 启用TCP keepalive（保持长连接）
    proxy_socket_keepalive on;

    # 启用TCP_NODELAY（降低延迟）
    tcp_nodelay on;

    # ========== SSL直通（可选，需要ssl_preread模块）==========
    # 如果需要基于SNI路由到不同后端，启用以下配置：
    # ssl_preread on;

    # ========== 代理协议（可选）==========
    # 如果CN2节点需要获取真实客户端IP，启用以下配置：
    # proxy_protocol on;
    # 注意：CN2节点的Nginx也需要配置 proxy_protocol 支持
}

# ============================================================
# HTTP负载均衡服务器（Port 80）
# ============================================================
server {
    listen 80;
    listen [::]:80;

    # TCP代理到上游CN2节点的80端口
    proxy_pass cn2_backend_http;

    # 超时配置（HTTP通常更短）
    proxy_connect_timeout 5s;
    proxy_timeout 30s;

    # TCP优化
    proxy_socket_keepalive on;
    tcp_nodelay on;
}

# ============================================================
# 配置说明
# ============================================================
#
# 1. 负载均衡算法选择：
#    - least_conn: 适合HTTP/HTTPS长连接，推荐用于AI API
#    - ip_hash: 适合需要会话保持的应用
#    - 轮询: 简单均匀分配，适合无状态服务
#
# 2. 故障检测机制：
#    - max_fails + fail_timeout: 被动检测（基于实际请求失败）
#    - nginx_healthcheck.sh: 主动检测（定期探测健康状态）
#
# 3. 性能调优：
#    - proxy_timeout: 根据AI响应时间调整（建议≥600秒）
#    - tcp_nodelay: 启用可降低延迟
#    - proxy_socket_keepalive: 启用可减少连接重建开销
#
# 4. 手动下线节点：
#    编辑此文件，在对应server行添加 down 标记：
#    server 1.2.3.4:443 weight=1 down;
#    然后重载Nginx: nginx -t && systemctl reload nginx
#
# 5. 权重调整（性能差异的节点）：
#    高性能节点: weight=3
#    中等性能节点: weight=2
#    低性能节点: weight=1
#
# 6. 监控和日志：
#    访问日志: /var/log/nginx/stream_access.log
#    错误日志: /var/log/nginx/stream_error.log
#
# ============================================================
